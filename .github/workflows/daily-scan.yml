name: Daily Scan - PuckTrend

on:
  # Run daily at 8:00 AM CET (07:00 UTC in winter, 06:00 UTC in summer)
  # Using 06:00 UTC to ensure it runs at 8 AM CEST (summer time)
  schedule:
    - cron: '0 6 * * *'  # 06:00 UTC = 08:00 CEST / 07:00 CET
  
  # Allow manual trigger for testing
  workflow_dispatch:

# Grant write permissions for GitHub Actions
permissions:
  contents: write

jobs:
  scan-and-analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install node-fetch
      
      - name: Run daily scan
        env:
          THE_ODDS_API_KEY: ${{ secrets.THE_ODDS_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TZ: Europe/Stockholm
        run: node scripts/daily-scan.js
      
      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "PuckTrend Bot"
          git add public/data/daily-picks.json
          git diff --staged --quiet || git commit -m "chore: daily scan results $(date +'%Y-%m-%d %H:%M CET')"
          git push
      
      - name: Notify on failure
        if: failure()
        run: |
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "content": "‚ö†Ô∏è **PuckTrend Daily Scan Failed**\n\nThe automated scan encountered an error. Please check the GitHub Actions logs.\n\nüîó [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
              }'
          fi
